name: TSPP CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  hygiene:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install tooling deps
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Schema hygiene checks
        run: |
          python scripts/schema_check.py

      - name: Python syntax smoke check
        run: |
          python -m compileall -q .

  integration:
    runs-on: ubuntu-latest
    needs: [hygiene]
    strategy:
      matrix:
        expected_al: ["AL1", "AL2"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install harness deps
        run: |
          python -m pip install --upgrade pip
          pip install -r harness/requirements.txt
          pip install fastapi uvicorn

      - name: Start reference SUT
        env:
          TSPP_REF_AL: ${{ matrix.expected_al }}
          TSPP_REF_BEARER_TOKEN: dev-token
        run: |
          uvicorn examples.reference_sut.app:app --host 127.0.0.1 --port 8001 &
          sleep 1

      - name: Run harness tests
        env:
          TRQP_BASE_URL: http://127.0.0.1:8001
          TRQP_BEARER_TOKEN: dev-token
          TSPP_EXPECT_AL: ${{ matrix.expected_al }}
          TSPP_REPORT_PATH: reports/tspp_conformance_${{ matrix.expected_al }}.json
        run: |
          pytest -q harness/tests

      - name: Upload conformance report
        uses: actions/upload-artifact@v4
        with:
          name: tspp-conformance-report-${{ matrix.expected_al }}
          path: reports/tspp_conformance_${{ matrix.expected_al }}.json
          if-no-files-found: error
