{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/sankarshanmukhopadhyay/TRQP-TSPP/main/schemas/core/tspp-trqp-signed-response.schema.json",
  "title": "TSPP TRQP Signed Response Envelope (AL2+)",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "payload",
    "signature"
  ],
  "properties": {
    "payload": {
      "description": "The unsigned response payload (authorization or recognition).",
      "oneOf": [
        {
          "$ref": "#/$defs/AuthorizationQueryResponse"
        },
        {
          "$ref": "#/$defs/RecognitionQueryResponse"
        }
      ]
    },
    "signature": {
      "$ref": "#/$defs/SignatureBlock"
    },
    "meta": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "query_hash",
        "iat",
        "exp"
      ],
      "properties": {
        "query_hash": {
          "type": "string",
          "minLength": 16,
          "maxLength": 256,
          "description": "Hash binding of the canonicalized request (and selected context keys) to the signed response."
        },
        "iat": {
          "type": "string",
          "format": "date-time",
          "description": "Issued-at time for the signed response envelope."
        },
        "exp": {
          "type": "string",
          "format": "date-time",
          "description": "Expiry time for the signed response envelope."
        },
        "nonce": {
          "type": "string",
          "minLength": 8,
          "maxLength": 128,
          "description": "Optional nonce for replay-resistance when supported."
        },
        "kid": {
          "type": "string",
          "minLength": 1,
          "maxLength": 128,
          "description": "Key identifier used for signature verification (if not derivable from the signature object)."
        }
      },
      "description": "Binding and time semantics for signed envelopes."
    }
  },
  "$defs": {
    "RFC3339DateTime": {
      "type": "string",
      "format": "date-time"
    },
    "DecisionTriState": {
      "type": "string",
      "enum": [
        "true",
        "false",
        "indeterminate"
      ]
    },
    "Provenance": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "governance_framework_id": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2048
        },
        "decision_record_id": {
          "type": "string",
          "maxLength": 2048
        },
        "effective_from": {
          "$ref": "#/$defs/RFC3339DateTime"
        },
        "effective_to": {
          "$ref": "#/$defs/RFC3339DateTime"
        }
      }
    },
    "ResponseMeta": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "time_evaluated",
        "expires_at"
      ],
      "properties": {
        "time_evaluated": {
          "$ref": "#/$defs/RFC3339DateTime"
        },
        "expires_at": {
          "$ref": "#/$defs/RFC3339DateTime"
        },
        "max_age_seconds": {
          "type": "integer",
          "minimum": 0
        },
        "policy_version": {
          "type": "string",
          "maxLength": 256
        },
        "provenance": {
          "$ref": "#/$defs/Provenance"
        }
      }
    },
    "AuthorizationQueryResponse": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "authorized",
        "meta"
      ],
      "properties": {
        "authorized": {
          "$ref": "#/$defs/DecisionTriState"
        },
        "meta": {
          "$ref": "#/$defs/ResponseMeta"
        }
      }
    },
    "RecognitionQueryResponse": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "recognized",
        "meta"
      ],
      "properties": {
        "recognized": {
          "$ref": "#/$defs/DecisionTriState"
        },
        "meta": {
          "$ref": "#/$defs/ResponseMeta"
        }
      }
    },
    "SignatureBlock": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "alg",
        "kid",
        "jws",
        "query_hash",
        "hash_alg",
        "canonicalization"
      ],
      "properties": {
        "alg": {
          "type": "string",
          "minLength": 2,
          "maxLength": 32,
          "description": "JWS algorithm identifier (e.g., ES256)."
        },
        "kid": {
          "type": "string",
          "minLength": 1,
          "maxLength": 256,
          "description": "Key identifier for signature verification."
        },
        "jws": {
          "type": "string",
          "minLength": 20,
          "description": "Compact JWS over canonical(payload) + query_hash binding (operator-defined signing input)."
        },
        "query_hash": {
          "type": "string",
          "minLength": 16,
          "maxLength": 512,
          "description": "Hash of canonical query parameters bound to this response."
        },
        "hash_alg": {
          "type": "string",
          "enum": [
            "SHA-256",
            "SHA-384",
            "SHA-512"
          ],
          "description": "Hash algorithm used for query_hash."
        },
        "canonicalization": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "json",
            "unicode",
            "context_keys_included"
          ],
          "properties": {
            "json": {
              "type": "string",
              "enum": [
                "JCS",
                "RFC8785",
                "operator-defined"
              ],
              "description": "Canonical JSON scheme used when computing query_hash and signing input."
            },
            "unicode": {
              "type": "string",
              "enum": [
                "NFC",
                "NFKC",
                "none"
              ],
              "description": "Unicode normalization applied before hashing/signing."
            },
            "context_keys_included": {
              "type": "array",
              "uniqueItems": true,
              "items": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              },
              "description": "Context keys included in the query_hash (subset of allowlisted keys)."
            }
          }
        },
        "issued_at": {
          "$ref": "#/$defs/RFC3339DateTime",
          "description": "Optional timestamp when signature was created."
        }
      }
    }
  }
}