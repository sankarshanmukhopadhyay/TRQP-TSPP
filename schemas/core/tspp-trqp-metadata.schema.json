{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://raw.githubusercontent.com/sankarshanmukhopadhyay/TRQP-TSPP/main/schemas/core/tspp-trqp-metadata.schema.json",
  "title": "TSPP TRQP Metadata",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "profile",
    "assurance_level",
    "auth",
    "rate_limits",
    "freshness",
    "context_allowlist",
    "signing",
    "recognition_policy"
  ],
  "properties": {
    "profile": {
      "type": "string",
      "const": "TSPP-TRQP-0.2",
      "description": "Profile identifier (schema + normative requirements set)."
    },
    "assurance_level": {
      "type": "string",
      "enum": [
        "AL1",
        "AL2",
        "AL3",
        "AL4"
      ],
      "description": "Declared assurance level for this TRQP deployment as defined by TSPP (AL1\u2013AL4)."
    },
    "operator": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "security_contact"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 256
        },
        "security_contact": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "email"
          ],
          "properties": {
            "email": {
              "type": "string",
              "format": "email"
            },
            "url": {
              "type": "string",
              "format": "uri"
            }
          }
        }
      },
      "description": "Optional operator metadata used for incident response and audit."
    },
    "auth": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "required",
        "methods",
        "max_token_ttl_seconds",
        "required_scopes"
      ],
      "properties": {
        "required": {
          "type": "boolean",
          "description": "Whether authentication is required for query endpoints."
        },
        "methods": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": [
              "bearer",
              "mtls",
              "dpop"
            ]
          },
          "description": "Supported authentication methods."
        },
        "max_token_ttl_seconds": {
          "type": "integer",
          "minimum": 1,
          "maximum": 86400,
          "description": "Maximum acceptable token TTL in seconds. Recommended <= 900."
        },
        "sender_constrained_required_for_bulk": {
          "type": "boolean",
          "default": false,
          "description": "If true, bulk clients must use sender-constrained tokens (mTLS/DPoP)."
        },
        "required_scopes": {
          "type": "array",
          "minItems": 1,
          "uniqueItems": true,
          "items": {
            "type": "string",
            "enum": [
              "trqp.authorization.query",
              "trqp.recognition.query"
            ]
          },
          "description": "Scopes enforced by the server."
        },
        "audience": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2048,
          "description": "Expected token 'aud' value for this registry (recommended)."
        }
      }
    },
    "rate_limits": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "per_client_rps",
        "per_ip_rps",
        "burst"
      ],
      "properties": {
        "per_client_rps": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100000
        },
        "per_ip_rps": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100000
        },
        "burst": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100000
        }
      },
      "description": "High-level rate limiting policy; detailed tiers may be described separately."
    },
    "freshness": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "max_staleness_seconds",
        "default_expires_seconds"
      ],
      "properties": {
        "max_staleness_seconds": {
          "type": "integer",
          "minimum": 0,
          "maximum": 31536000,
          "description": "Client-enforced maximum staleness for sensitive operations."
        },
        "default_expires_seconds": {
          "type": "integer",
          "minimum": 1,
          "maximum": 31536000,
          "description": "Default validity window for responses."
        }
      }
    },
    "context_allowlist": {
      "type": "array",
      "minItems": 0,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "minLength": 1,
        "maxLength": 128
      },
      "description": "Explicit list of accepted context keys. Unknown keys must be rejected or stripped."
    },
    "namespacing": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "action_required",
        "resource_required",
        "versioning_required"
      ],
      "properties": {
        "action_required": {
          "type": "boolean"
        },
        "resource_required": {
          "type": "boolean"
        },
        "versioning_required": {
          "type": "boolean"
        },
        "recommended_formats": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": [
              "uri",
              "urn",
              "did-fragment"
            ]
          }
        }
      },
      "description": "Declares whether namespaced/versioned action/resource tokens are required."
    },
    "signing": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "supported",
        "required_for_al2",
        "algorithms",
        "jwks_uri",
        "canonicalization"
      ],
      "properties": {
        "supported": {
          "type": "boolean"
        },
        "required_for_al2": {
          "type": "boolean"
        },
        "algorithms": {
          "type": "array",
          "minItems": 0,
          "items": {
            "type": "string",
            "minLength": 2,
            "maxLength": 32
          }
        },
        "jwks_uri": {
          "type": "string",
          "format": "uri",
          "description": "JWKS endpoint for verifying signed responses."
        },
        "canonicalization": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "json_canonicalization",
            "unicode_normalization",
            "context_keys_included_in_hash"
          ],
          "properties": {
            "json_canonicalization": {
              "type": "string",
              "enum": [
                "JCS",
                "RFC8785",
                "operator-defined"
              ],
              "description": "Canonical JSON scheme used for query_hash binding."
            },
            "unicode_normalization": {
              "type": "string",
              "enum": [
                "NFC",
                "NFKC",
                "none"
              ],
              "description": "Unicode normalization applied before hashing."
            },
            "context_keys_included_in_hash": {
              "type": "array",
              "minItems": 0,
              "uniqueItems": true,
              "items": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              },
              "description": "Subset of allowlisted context keys included in the query_hash."
            }
          }
        },
        "default_signed_responses": {
          "type": "boolean",
          "description": "If true, the service signs successful machine-consumed responses by default (even when clients do not explicitly request a signature)."
        },
        "sign_errors": {
          "type": "string",
          "enum": [
            "MAY",
            "SHOULD",
            "MUST"
          ],
          "description": "Policy for signing structured error responses (4xx/structured denials)."
        },
        "binding": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "query_hash_required",
            "iat_required",
            "exp_required",
            "max_ttl_seconds"
          ],
          "properties": {
            "query_hash_required": {
              "type": "boolean",
              "description": "Whether signed envelopes MUST include a query_hash that binds the request to the response."
            },
            "iat_required": {
              "type": "boolean",
              "description": "Whether signed envelopes MUST include an issued-at (iat) timestamp."
            },
            "exp_required": {
              "type": "boolean",
              "description": "Whether signed envelopes MUST include an expiry (exp) timestamp."
            },
            "max_ttl_seconds": {
              "type": "integer",
              "minimum": 1,
              "maximum": 604800,
              "description": "Maximum allowed TTL in seconds for signed responses (exp - iat)."
            }
          },
          "description": "Binding and time semantics required in signed envelopes."
        },
        "key_lifecycle": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "rotation_max_days",
            "overlap_min_days",
            "revocation_supported",
            "revocation_uri"
          ],
          "properties": {
            "rotation_max_days": {
              "type": "integer",
              "minimum": 1,
              "maximum": 365,
              "description": "Maximum key rotation interval (days)."
            },
            "overlap_min_days": {
              "type": "integer",
              "minimum": 0,
              "maximum": 90,
              "description": "Minimum overlap window (days) when rotating keys to avoid verification failures."
            },
            "revocation_supported": {
              "type": "boolean",
              "description": "Whether key revocation is supported and communicated to verifiers."
            },
            "revocation_uri": {
              "type": "string",
              "format": "uri",
              "description": "URL describing how verifiers learn about key revocations/withdrawals (could be a feed, transparency log, or policy page)."
            }
          },
          "description": "Key lifecycle controls advertised for auditability."
        }
      }
    },
    "recognition_policy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "scoped_required",
        "expiry_required",
        "transitive_default",
        "max_chain_depth"
      ],
      "properties": {
        "scoped_required": {
          "type": "boolean"
        },
        "expiry_required": {
          "type": "boolean"
        },
        "transitive_default": {
          "type": "boolean"
        },
        "max_chain_depth": {
          "type": "integer",
          "minimum": 0,
          "maximum": 32
        }
      }
    },
    "transparency": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "change_log_uri",
        "published_at"
      ],
      "properties": {
        "change_log_uri": {
          "type": "string",
          "format": "uri",
          "description": "Human- and machine-readable change log for operationally meaningful changes (metadata/JWKS/policy)."
        },
        "published_at": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp when this metadata was last published/updated."
        }
      },
      "description": "Change transparency signals that enable relying parties to detect drift."
    },
    "key_protection": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "protection",
        "evidence_uri"
      ],
      "properties": {
        "protection": {
          "type": "string",
          "enum": [
            "software",
            "KMS",
            "HSM"
          ],
          "description": "How signing keys are protected at rest and during signing operations."
        },
        "evidence_uri": {
          "type": "string",
          "format": "uri",
          "description": "URL to an auditable statement about key custody and protection (policy, audit letter, or attestation evidence)."
        },
        "attestation_type": {
          "type": "string",
          "enum": [
            "none",
            "policy_statement",
            "third_party_audit",
            "remote_attestation"
          ],
          "description": "Type of evidence available for key protection claims."
        }
      },
      "description": "Key custody and protection posture (AL4 focus)."
    },
    "monitoring": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "evidence_retention_days",
        "incident_contact",
        "runbook_uri"
      ],
      "properties": {
        "evidence_retention_days": {
          "type": "integer",
          "minimum": 1,
          "maximum": 3650,
          "description": "Minimum retention period for security-relevant evidence (logs, signature verification telemetry, change events)."
        },
        "incident_contact": {
          "type": "string",
          "minLength": 3,
          "maxLength": 256,
          "description": "Contact for security incidents and operational escalations."
        },
        "runbook_uri": {
          "type": "string",
          "format": "uri",
          "description": "URL to an incident response / operational runbook (high-level is acceptable)."
        }
      },
      "description": "Operational monitoring and incident readiness signals (AL4 focus)."
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "assurance_level": {
            "const": "AL2"
          }
        }
      },
      "then": {
        "properties": {
          "signing": {
            "required": [
              "supported",
              "required_for_al2"
            ]
          }
        },
        "allOf": [
          {
            "properties": {
              "signing": {
                "properties": {
                  "supported": {
                    "const": true
                  },
                  "required_for_al2": {
                    "const": true
                  }
                }
              }
            }
          }
        ]
      }
    },
    {
      "if": {
        "properties": {
          "assurance_level": {
            "const": "AL3"
          }
        }
      },
      "then": {
        "required": [
          "transparency"
        ],
        "properties": {
          "signing": {
            "required": [
              "supported",
              "default_signed_responses",
              "sign_errors",
              "binding",
              "key_lifecycle"
            ],
            "properties": {
              "supported": {
                "const": true
              },
              "default_signed_responses": {
                "const": true
              },
              "sign_errors": {
                "enum": [
                  "SHOULD",
                  "MUST"
                ]
              },
              "binding": {
                "properties": {
                  "query_hash_required": {
                    "const": true
                  },
                  "iat_required": {
                    "const": true
                  },
                  "exp_required": {
                    "const": true
                  }
                }
              }
            }
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "assurance_level": {
            "const": "AL4"
          }
        }
      },
      "then": {
        "required": [
          "transparency",
          "key_protection",
          "monitoring"
        ],
        "properties": {
          "signing": {
            "required": [
              "supported",
              "default_signed_responses",
              "sign_errors",
              "binding",
              "key_lifecycle"
            ],
            "properties": {
              "supported": {
                "const": true
              },
              "default_signed_responses": {
                "const": true
              },
              "sign_errors": {
                "const": "MUST"
              },
              "binding": {
                "properties": {
                  "query_hash_required": {
                    "const": true
                  },
                  "iat_required": {
                    "const": true
                  },
                  "exp_required": {
                    "const": true
                  }
                }
              }
            }
          }
        }
      }
    }
  ]
}