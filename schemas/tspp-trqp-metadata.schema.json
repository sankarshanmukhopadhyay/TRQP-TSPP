{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/schemas/tspp-trqp-metadata.schema.json",
  "title": "TSPP TRQP Metadata",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "profile",
    "assurance_level",
    "auth",
    "rate_limits",
    "freshness",
    "context_allowlist",
    "signing",
    "recognition_policy"
  ],
  "properties": {
    "profile": {
      "type": "string",
      "const": "TSPP-TRQP-0.1",
      "description": "Profile identifier."
    },
    "assurance_level": {
      "type": "string",
      "enum": [
        "AL1",
        "AL2"
      ],
      "description": "Declared assurance level for this TRQP deployment."
    },
    "operator": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "name",
        "security_contact"
      ],
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 256
        },
        "security_contact": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "email"
          ],
          "properties": {
            "email": {
              "type": "string",
              "format": "email"
            },
            "url": {
              "type": "string",
              "format": "uri"
            }
          }
        }
      },
      "description": "Optional operator metadata used for incident response and audit."
    },
    "auth": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "required",
        "methods",
        "max_token_ttl_seconds",
        "required_scopes"
      ],
      "properties": {
        "required": {
          "type": "boolean",
          "description": "Whether authentication is required for query endpoints."
        },
        "methods": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": [
              "bearer",
              "mtls",
              "dpop"
            ]
          },
          "description": "Supported authentication methods."
        },
        "max_token_ttl_seconds": {
          "type": "integer",
          "minimum": 1,
          "maximum": 86400,
          "description": "Maximum acceptable token TTL in seconds. Recommended <= 900."
        },
        "sender_constrained_required_for_bulk": {
          "type": "boolean",
          "default": false,
          "description": "If true, bulk clients must use sender-constrained tokens (mTLS/DPoP)."
        },
        "required_scopes": {
          "type": "array",
          "minItems": 1,
          "uniqueItems": true,
          "items": {
            "type": "string",
            "enum": [
              "trqp.authorization.query",
              "trqp.recognition.query"
            ]
          },
          "description": "Scopes enforced by the server."
        },
        "audience": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2048,
          "description": "Expected token 'aud' value for this registry (recommended)."
        }
      }
    },
    "rate_limits": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "per_client_rps",
        "per_ip_rps",
        "burst"
      ],
      "properties": {
        "per_client_rps": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100000
        },
        "per_ip_rps": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100000
        },
        "burst": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100000
        }
      },
      "description": "High-level rate limiting policy; detailed tiers may be described separately."
    },
    "freshness": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "max_staleness_seconds",
        "default_expires_seconds"
      ],
      "properties": {
        "max_staleness_seconds": {
          "type": "integer",
          "minimum": 0,
          "maximum": 31536000,
          "description": "Client-enforced maximum staleness for sensitive operations."
        },
        "default_expires_seconds": {
          "type": "integer",
          "minimum": 1,
          "maximum": 31536000,
          "description": "Default validity window for responses."
        }
      }
    },
    "context_allowlist": {
      "type": "array",
      "minItems": 0,
      "uniqueItems": true,
      "items": {
        "type": "string",
        "minLength": 1,
        "maxLength": 128
      },
      "description": "Explicit list of accepted context keys. Unknown keys must be rejected or stripped."
    },
    "namespacing": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "action_required",
        "resource_required",
        "versioning_required"
      ],
      "properties": {
        "action_required": {
          "type": "boolean"
        },
        "resource_required": {
          "type": "boolean"
        },
        "versioning_required": {
          "type": "boolean"
        },
        "recommended_formats": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "enum": [
              "uri",
              "urn",
              "did-fragment"
            ]
          }
        }
      },
      "description": "Declares whether namespaced/versioned action/resource tokens are required."
    },
    "signing": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "supported",
        "required_for_al2",
        "algorithms",
        "jwks_uri",
        "canonicalization"
      ],
      "properties": {
        "supported": {
          "type": "boolean"
        },
        "required_for_al2": {
          "type": "boolean"
        },
        "algorithms": {
          "type": "array",
          "minItems": 0,
          "items": {
            "type": "string",
            "minLength": 2,
            "maxLength": 32
          }
        },
        "jwks_uri": {
          "type": "string",
          "format": "uri",
          "description": "JWKS endpoint for verifying signed responses."
        },
        "canonicalization": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "json_canonicalization",
            "unicode_normalization",
            "context_keys_included_in_hash"
          ],
          "properties": {
            "json_canonicalization": {
              "type": "string",
              "enum": [
                "JCS",
                "RFC8785",
                "operator-defined"
              ],
              "description": "Canonical JSON scheme used for query_hash binding."
            },
            "unicode_normalization": {
              "type": "string",
              "enum": [
                "NFC",
                "NFKC",
                "none"
              ],
              "description": "Unicode normalization applied before hashing."
            },
            "context_keys_included_in_hash": {
              "type": "array",
              "minItems": 0,
              "uniqueItems": true,
              "items": {
                "type": "string",
                "minLength": 1,
                "maxLength": 128
              },
              "description": "Subset of allowlisted context keys included in the query_hash."
            }
          }
        }
      }
    },
    "recognition_policy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "scoped_required",
        "expiry_required",
        "transitive_default",
        "max_chain_depth"
      ],
      "properties": {
        "scoped_required": {
          "type": "boolean"
        },
        "expiry_required": {
          "type": "boolean"
        },
        "transitive_default": {
          "type": "boolean"
        },
        "max_chain_depth": {
          "type": "integer",
          "minimum": 0,
          "maximum": 32
        }
      }
    }
  }
}
